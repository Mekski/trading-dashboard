<!DOCTYPE html>
<html lang="en" data-theme="dark" data-accent="default">
<head>
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const savedMode = localStorage.getItem('themeMode') || 'dark';
            const savedAccent = localStorage.getItem('accentColor') || 'default';
            document.documentElement.setAttribute('data-theme', savedMode);
            document.documentElement.setAttribute('data-accent', savedAccent);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX Trading Dashboard</title>
    
    <!-- Modern fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    
    <!-- Chart library -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    
    <!-- External CSS - SAME AS MODERN DASHBOARD -->
    <link rel="stylesheet" href="/static/css/modern-dashboard.css">
    
    <style>
        /* Ensure theme variables are applied */
        :root[data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success-color: #10b981;
            --error-color: #ef4444;
            --accent-color: var(--primary);
            --accent-gradient-start: var(--primary);
            --accent-gradient-end: var(--secondary);
        }
        
        :root[data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-card: rgba(255, 255, 255, 0.9);
            --border-light: rgba(0, 0, 0, 0.1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --accent-color: var(--primary);
            --accent-gradient-start: var(--primary);
            --accent-gradient-end: var(--secondary);
        }
        
        /* Add shadow color variables for different themes */
        :root {
            --secondary-shadow: rgba(34, 211, 238, 0.3);
            --secondary-shadow-hover: rgba(34, 211, 238, 0.4);
        }
        
        [data-accent="purple"] {
            --secondary-shadow: rgba(236, 72, 153, 0.3);
            --secondary-shadow-hover: rgba(236, 72, 153, 0.4);
        }
        
        [data-accent="green"] {
            --secondary-shadow: rgba(20, 184, 166, 0.3);
            --secondary-shadow-hover: rgba(20, 184, 166, 0.4);
        }
        
        [data-accent="orange"] {
            --secondary-shadow: rgba(245, 158, 11, 0.3);
            --secondary-shadow-hover: rgba(245, 158, 11, 0.4);
        }
        
        [data-accent="pink"] {
            --secondary-shadow: rgba(244, 63, 94, 0.3);
            --secondary-shadow-hover: rgba(244, 63, 94, 0.4);
        }
        
        [data-accent="blue"] {
            --secondary-shadow: rgba(6, 182, 212, 0.3);
            --secondary-shadow-hover: rgba(6, 182, 212, 0.4);
        }
        
        [data-accent="red"] {
            --secondary-shadow: rgba(249, 115, 22, 0.3);
            --secondary-shadow-hover: rgba(249, 115, 22, 0.4);
        }
        
        [data-accent="teal"] {
            --secondary-shadow: rgba(6, 182, 212, 0.3);
            --secondary-shadow-hover: rgba(6, 182, 212, 0.4);
        }
        
        [data-accent="amber"] {
            --secondary-shadow: rgba(249, 115, 22, 0.3);
            --secondary-shadow-hover: rgba(249, 115, 22, 0.4);
        }
        
        [data-accent="indigo"] {
            --secondary-shadow: rgba(124, 58, 237, 0.3);
            --secondary-shadow-hover: rgba(124, 58, 237, 0.4);
        }
        
        [data-accent="rose"] {
            --secondary-shadow: rgba(236, 72, 153, 0.3);
            --secondary-shadow-hover: rgba(236, 72, 153, 0.4);
        }
        
        [data-accent="emerald"] {
            --secondary-shadow: rgba(6, 182, 212, 0.3);
            --secondary-shadow-hover: rgba(6, 182, 212, 0.4);
        }
        
        /* View mode toggle for distribution chart */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .view-toggle button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .view-toggle button:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-color);
        }
        
        .view-toggle button.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        /* Download button styling to match nav-pills and theme */
        .download-pill {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s var(--animation-smooth, ease);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--secondary-shadow);
        }
        
        .download-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px var(--secondary-shadow-hover);
            background: linear-gradient(135deg, var(--secondary-dark), var(--secondary));
        }
        
        .download-pill:active {
            transform: translateY(0);
        }
        
        .download-pill i {
            margin-right: 0.5rem;
        }
        
        .download-pill:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading animation for download button */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .download-pill .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Hide charts initially */
        .individual-charts {
            display: none;
        }
        
        .individual-charts.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Background gradient - SAME AS MODERN -->
    <div class="bg-gradient"></div>
    
    <!-- Grid overlay - SAME AS MODERN -->
    <div class="grid-overlay"></div>
    
    <!-- Subtle gradient orbs - SAME AS MODERN -->
    <div class="subtle-orb subtle-orb1"></div>
    <div class="subtle-orb subtle-orb2"></div>
    <div class="subtle-orb subtle-orb3"></div>
    
    <!-- Animated particles container - SAME AS MODERN -->
    <div id="particlesContainer"></div>

    <!-- Enhanced loading overlay - SAME AS MODERN -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="ri-exchange-dollar-line"></i>
            </div>
            <div class="loading-text">Loading OKX Dashboard</div>
            <div class="loading-subtext">Calculating positions and P&L...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Theme switcher - EXACT SAME AS MODERN -->
    <div class="theme-switcher" id="themeSwitcher">
        <button class="theme-toggle-btn" id="themeToggleBtn">
            <i class="ri-palette-line"></i>
        </button>
        <div class="theme-options">
            <div class="theme-option-group">
                <div class="theme-option-label">Theme Mode</div>
                <div class="theme-mode-toggle">
                    <button class="mode-btn" id="lightModeBtn">
                        <i class="ri-sun-line"></i>
                        Light
                    </button>
                    <button class="mode-btn active" id="darkModeBtn">
                        <i class="ri-moon-line"></i>
                        Dark
                    </button>
                </div>
            </div>
            <div class="theme-option-group">
                <div class="theme-option-label">Accent Color</div>
                <div class="theme-option-row" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                    <div class="color-option" data-accent="default" style="background: linear-gradient(135deg, #6366f1, #22d3ee);" title="Indigo"></div>
                    <div class="color-option" data-accent="purple" style="background: linear-gradient(135deg, #9333ea, #ec4899);" title="Purple"></div>
                    <div class="color-option" data-accent="green" style="background: linear-gradient(135deg, #10b981, #14b8a6);" title="Green"></div>
                    <div class="color-option" data-accent="orange" style="background: linear-gradient(135deg, #f97316, #f59e0b);" title="Orange"></div>
                    <div class="color-option" data-accent="pink" style="background: linear-gradient(135deg, #ec4899, #f43f5e);" title="Pink"></div>
                    <div class="color-option" data-accent="blue" style="background: linear-gradient(135deg, #3b82f6, #06b6d4);" title="Blue"></div>
                    <div class="color-option" data-accent="red" style="background: linear-gradient(135deg, #ef4444, #f97316);" title="Red"></div>
                    <div class="color-option" data-accent="teal" style="background: linear-gradient(135deg, #14b8a6, #06b6d4);" title="Teal"></div>
                    <div class="color-option" data-accent="amber" style="background: linear-gradient(135deg, #f59e0b, #f97316);" title="Amber"></div>
                    <div class="color-option" data-accent="indigo" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);" title="Indigo"></div>
                    <div class="color-option" data-accent="rose" style="background: linear-gradient(135deg, #f43f5e, #ec4899);" title="Rose"></div>
                    <div class="color-option" data-accent="emerald" style="background: linear-gradient(135deg, #10b981, #06b6d4);" title="Emerald"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main container - SAME CLASS AS MODERN -->
    <div class="container">
        <!-- Header - EXACT SAME STRUCTURE AS MODERN -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="ri-exchange-dollar-line"></i>
                </div>
                <div class="logo-text">OKX Dashboard</div>
            </div>
            
            <nav class="nav-pills">
                <a href="/" class="nav-pill">
                    <i class="ri-arrow-left-line"></i> Back
                </a>
                <button class="nav-pill active" data-account="all">All Accounts</button>
                <button class="nav-pill" data-account="account1">cyg6</button>
                <button class="nav-pill" data-account="account2">cyg7</button>
                <button class="nav-pill" data-account="account3">cyg8</button>
                <button class="download-pill" onclick="downloadPositionsCSV()">
                    <i class="ri-download-line"></i> Download CSV
                </button>
            </nav>
        </header>

        <!-- Stats Cards Row -->
        <div style="display: flex; justify-content: center; gap: 1rem; margin: 1.5rem 0; flex-wrap: wrap;">
            <div class="stat-card" style="min-width: 280px;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="ri-funds-line"></i>
                    </div>
                    <div>
                        <div class="stat-label">Total P&L</div>
                        <div class="stat-value" id="totalPnlValue">$0.00</div>
                        <div class="stat-change" id="totalPnlChange">
                            <span id="pnlSubtitle">All time</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Merged Card: Trading Activity -->
            <div class="stat-card" style="min-width: 280px;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="ri-exchange-line"></i>
                    </div>
                    <div>
                        <div class="stat-label">Trading Activity</div>
                        <div class="stat-value" id="totalTradesValue">0</div>
                        <div class="stat-change">
                            <span id="tradingActivitySubtitle">0 positions â€¢ 0 orders</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Win Rate Card -->
            <div class="stat-card" style="min-width: 280px;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="ri-percent-line"></i>
                    </div>
                    <div>
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="winRateValue">0%</div>
                        <div class="stat-change">
                            <span id="winRateSubtitle">0 wins / 0 total</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- New Card: Drawdown -->
            <div class="stat-card" style="min-width: 280px;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="ri-line-chart-line"></i>
                    </div>
                    <div>
                        <div class="stat-label">Drawdown</div>
                        <div class="stat-value" id="drawdownValue">0.0%</div>
                        <div class="stat-change">
                            <span id="drawdownSubtitle">Max: 0.0%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- New Card: Total Fees -->
            <div class="stat-card" style="min-width: 280px;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="ri-money-dollar-circle-line"></i>
                    </div>
                    <div>
                        <div class="stat-label">Total Fees</div>
                        <div class="stat-value" id="totalFeesValue">$0.00</div>
                        <div class="stat-change">
                            <span id="totalFeesSubtitle">Trading: $0.00 â€¢ Funding: $0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Symbol Filter Pills - USING NAV-PILLS CLASS -->
        <div style="margin: 1rem 0;">
            <nav class="nav-pills" style="justify-content: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                <button class="nav-pill active" data-symbol="all">All Symbols</button>
                <button class="nav-pill" data-symbol="BTC-USD-SWAP">BTC-USD</button>
                <button class="nav-pill" data-symbol="BTC-USDT-SWAP">BTC-USDT</button>
                <button class="nav-pill" data-symbol="ETH-USD-SWAP">ETH-USD</button>
                <button class="nav-pill" data-symbol="ETH-USDT-SWAP">ETH-USDT</button>
                <button class="nav-pill" data-symbol="SOL-USD-SWAP">SOL-USD</button>
                <button class="nav-pill" data-symbol="SOL-USDT-SWAP">SOL-USDT</button>
                <button class="nav-pill" data-symbol="LTC-USD-SWAP">LTC-USD</button>
                <button class="nav-pill" data-symbol="LTC-USDT-SWAP">LTC-USDT</button>
            </nav>
        </div>

        <!-- Main Cumulative P&L Chart - Always visible -->
        <div class="chart-container" id="chartContainer">
            <div class="chart-header">
                <div class="chart-title">
                    <div class="chart-title-icon">
                        <i class="ri-stock-line"></i>
                    </div>
                    <span id="chartTitle">Cumulative P&L Timeline</span>
                </div>
                <div class="chart-controls">
                    <!-- Chart Type Toggle -->
                    <div class="view-toggle" style="margin-right: 1rem;">
                        <button class="active" data-chart="pnl">P&L</button>
                        <button data-chart="drawdown">Drawdown</button>
                    </div>
                    
                    <!-- Zoom Stats Button (hidden by default) -->
                    <button id="zoomStatsBtn" class="nav-pill" style="display: none; margin-right: 1rem;">
                        <i class="ri-focus-3-line"></i> Show Zoomed Stats
                    </button>
                    
                    <div class="time-selector">
                        <button class="time-btn" data-range="1D">1D</button>
                        <button class="time-btn" data-range="1W">1W</button>
                        <button class="time-btn" data-range="1M">1M</button>
                        <button class="time-btn" data-range="3M">3M</button>
                        <button class="time-btn" data-range="6M">6M</button>
                        <button class="time-btn active" data-range="ALL">All</button>
                    </div>
                </div>
            </div>
            <div id="cumulativePnlChart" style="height: 400px;"></div>
        </div>

        <!-- Individual Account+Symbol Charts - Only visible when both are selected -->
        <div class="individual-charts" id="individualCharts">
            <!-- Position Chart (from okx-orders) -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <div class="chart-title-icon">
                            <i class="ri-bar-chart-grouped-line"></i>
                        </div>
                        <span id="positionChartTitle">Position Over Time</span>
                    </div>
                </div>
                <div id="positionChart" style="height: 350px;"></div>
            </div>

            <!-- Returns Distribution (from okx-positions) -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <div class="chart-title-icon">
                            <i class="ri-bar-chart-2-line"></i>
                        </div>
                        <span>Position Returns Distribution</span>
                    </div>
                    <div class="view-toggle">
                        <button class="active" data-view="histogram">Histogram</button>
                        <button data-view="timeline">Timeline</button>
                    </div>
                </div>
                <div id="distributionChart" style="height: 350px;"></div>
            </div>
        </div>
        
        <!-- Extended Analytics Section (New) -->
        <div id="extendedAnalytics" class="extended-analytics" style="margin-top: 30px;">
            <!-- Analytics Toggle Button -->
            <div class="analytics-header" style="cursor: pointer; padding: 15px; background: var(--card-bg); border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="icon-box">
                        <i class="ri-line-chart-line"></i>
                    </div>
                    <span style="font-size: 1.1em; font-weight: 600;">Extended Analytics</span>
                    <span id="analyticsTradeCount" style="font-size: 0.9em; opacity: 0.7;"></span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="analyticsStatus" style="font-size: 0.9em; opacity: 0.7;"></span>
                    <i id="analyticsToggleIcon" class="ri-arrow-down-s-line" style="font-size: 1.5em; transition: transform 0.3s;"></i>
                </div>
            </div>
            
            <!-- Analytics Content (Initially Hidden) -->
            <div id="analyticsContent" style="display: none;">
                <!-- First Row: Return Distribution and Hold Time -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Return Distribution -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="icon-box">
                                    <i class="ri-bar-chart-grouped-line"></i>
                                </div>
                                <span>Return Distribution Analysis</span>
                            </div>
                        </div>
                        <div id="returnDistributionChart" style="height: 300px;"></div>
                    </div>
                    
                    <!-- Hold Time Distribution -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="icon-box">
                                    <i class="ri-time-line"></i>
                                </div>
                                <span>Hold Time Distribution</span>
                            </div>
                        </div>
                        <div id="holdTimeChart" style="height: 300px;"></div>
                    </div>
                </div>
                
                <!-- Market vs Model Return Analysis - REMOVED per user request
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="icon-box">
                                    <i class="ri-line-chart-line"></i>
                                </div>
                                <span>Market Returns vs Model Returns (When Active)</span>
                            </div>
                        </div>
                        <div id="marketVsModelChart" style="height: 400px;"></div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="icon-box">
                                    <i class="ri-dashboard-line"></i>
                                </div>
                                <span>Performance Summary</span>
                            </div>
                        </div>
                        <div id="efficiencyMetrics" style="padding: 20px;">
                        </div>
                    </div>
                </div>
                -->
                
                <!-- Third Row: Instrument Performance Table -->
                <div class="chart-container" id="instrumentPerformanceContainer" style="display: none;">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="icon-box">
                                <i class="ri-trophy-line"></i>
                            </div>
                            <span>Performance by Instrument</span>
                            <span style="font-size: 0.85em; opacity: 0.7;">(All instruments shown for comparison)</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto; max-height: 400px;">
                        <table id="instrumentPerformanceTable" style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                                <tr>
                                    <th style="text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color);">Instrument</th>
                                    <th style="text-align: right; padding: 12px; border-bottom: 2px solid var(--border-color);">Positions</th>
                                    <th style="text-align: right; padding: 12px; border-bottom: 2px solid var(--border-color);">Win Rate</th>
                                    <th style="text-align: right; padding: 12px; border-bottom: 2px solid var(--border-color);">W/L</th>
                                    <th style="text-align: right; padding: 12px; border-bottom: 2px solid var(--border-color);">Total P&L</th>
                                    <th style="text-align: right; padding: 12px; border-bottom: 2px solid var(--border-color);">Fees</th>
                                    <th style="text-align: right; padding: 12px; border-bottom: 2px solid var(--border-color);">Net P&L</th>
                                    <th style="text-align: right; padding: 12px; border-bottom: 2px solid var(--border-color);">Avg Hold</th>
                                </tr>
                            </thead>
                            <tbody id="instrumentPerformanceBody">
                                <!-- Rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Warning for Low Trade Count -->
                <div id="analyticsWarning" class="warning-box" style="display: none; margin-top: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px;">
                    <i class="ri-alert-line" style="color: #fbbf24; margin-right: 8px;"></i>
                    <span id="analyticsWarningText"></span>
                </div>
            </div>
        </div>

    </div>

    <!-- Include modern dashboard JS for particles and base functionality -->
    <script src="/static/js/modern-dashboard.js"></script>
    
    <!-- OKX Specific JavaScript -->
    <script>
        // Initialize theme IMMEDIATELY before page renders
        (function initializeThemeImmediately() {
            const savedMode = localStorage.getItem('themeMode') || 'dark';
            const savedAccent = localStorage.getItem('accentColor') || 'default';
            
            // Set theme on document element immediately
            document.documentElement.setAttribute('data-theme', savedMode);
            document.documentElement.setAttribute('data-accent', savedAccent);
        })();
        
        // Update UI elements after DOM loads
        window.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('themeMode') || 'dark';
            const savedAccent = localStorage.getItem('accentColor') || 'default';
            
            // Update button states for theme mode
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = savedMode === 'light' ? document.getElementById('lightModeBtn') : document.getElementById('darkModeBtn');
            if (activeBtn) activeBtn.classList.add('active');
            
            // Update color option states
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
            const activeOption = document.querySelector(`[data-accent="${savedAccent}"]`);
            if (activeOption) activeOption.classList.add('active');
        });

        // OKX Dashboard Controller
        class OKXDashboard {
            constructor() {
                this.currentFilters = {
                    account: 'all',
                    symbol: 'all',
                    time_filter: 'all'
                };
                
                this.chartData = null;
                this.summaryData = null;
                this.orderData = null;
                this.positionData = null;
                this.distributionViewMode = 'histogram';
                this.mainChartMode = 'pnl'; // 'pnl' or 'drawdown'
                
                // Zoom tracking
                this.isZoomed = false;
                this.zoomRange = null;
                this.showZoomedStats = false;
                this.isSyncingZoom = false; // Flag to prevent infinite zoom sync loops
                
                this.initializeEventListeners();
                this.loadData();
                // Update position count on initial load
                this.updateAnalyticsPositionCount();
                
                // Auto-refresh every 5 minutes
                setInterval(() => this.loadData(), 5 * 60 * 1000);
            }
            
            initializeEventListeners() {
                // Account nav pills
                document.querySelectorAll('[data-account]').forEach(pill => {
                    if (pill.classList.contains('nav-pill')) {
                        pill.addEventListener('click', (e) => {
                            document.querySelectorAll('.nav-pill[data-account]').forEach(p => p.classList.remove('active'));
                            pill.classList.add('active');
                            
                            this.currentFilters.account = pill.dataset.account;
                            this.loadData();
                            this.checkIndividualChartsVisibility();
                            // Update position count in Extended Analytics header
                            this.updateAnalyticsPositionCount();
                            // Reload analytics if expanded
                            if (this.analyticsExpanded) {
                                this.loadExtendedAnalytics();
                            }
                        });
                    }
                });
                
                // Symbol nav pills
                document.querySelectorAll('[data-symbol]').forEach(pill => {
                    pill.addEventListener('click', (e) => {
                        document.querySelectorAll('[data-symbol]').forEach(p => p.classList.remove('active'));
                        pill.classList.add('active');
                        
                        this.currentFilters.symbol = pill.dataset.symbol;
                        this.loadData();
                        this.checkIndividualChartsVisibility();
                        // Update position count in Extended Analytics header
                        this.updateAnalyticsPositionCount();
                        // Reload analytics if expanded
                        if (this.analyticsExpanded) {
                            this.loadExtendedAnalytics();
                        }
                    });
                });
                
                // Time range buttons
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const range = btn.dataset.range;
                        this.updateChartTimeRange(range);
                    });
                });
                
                // View toggle for distribution chart (specifically for the distribution chart)
                document.querySelectorAll('#individualCharts .view-toggle button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const toggleContainer = btn.parentElement;
                        toggleContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        this.distributionViewMode = btn.dataset.view;
                        this.updateDistributionChart();
                    });
                });
                
                // Extended Analytics Toggle
                const analyticsHeader = document.querySelector('.analytics-header');
                const analyticsContent = document.getElementById('analyticsContent');
                const analyticsToggleIcon = document.getElementById('analyticsToggleIcon');
                this.analyticsExpanded = true;  // Default to expanded
                
                // Set initial state to expanded
                if (analyticsContent && analyticsToggleIcon) {
                    analyticsContent.style.display = 'block';
                    analyticsToggleIcon.style.transform = 'rotate(180deg)';
                    // Load analytics data on page load
                    this.loadExtendedAnalytics().then(() => {
                        document.getElementById('analyticsStatus').textContent = '';
                    });
                }
                
                if (analyticsHeader) {
                    analyticsHeader.addEventListener('click', () => {
                        this.analyticsExpanded = !this.analyticsExpanded;
                        
                        if (this.analyticsExpanded) {
                            analyticsContent.style.display = 'block';
                            analyticsToggleIcon.style.transform = 'rotate(180deg)';
                            document.getElementById('analyticsStatus').textContent = 'Loading...';
                            // Load analytics data
                            this.loadExtendedAnalytics().then(() => {
                                document.getElementById('analyticsStatus').textContent = '';
                            });
                        } else {
                            analyticsContent.style.display = 'none';
                            analyticsToggleIcon.style.transform = 'rotate(0deg)';
                            document.getElementById('analyticsStatus').textContent = '';
                        }
                        
                        // Save preference
                        localStorage.setItem('okxAnalyticsExpanded', this.analyticsExpanded);
                    });
                    
                    // Restore preference after a delay to ensure DOM is ready
                    setTimeout(() => {
                        const savedState = localStorage.getItem('okxAnalyticsExpanded');
                        if (savedState === 'true') {
                            analyticsHeader.click();
                        }
                    }, 100);
                }
                
                // Chart type toggle for main chart (P&L vs Drawdown)
                document.querySelectorAll('#chartContainer .view-toggle button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const toggleContainer = btn.parentElement;
                        toggleContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        this.mainChartMode = btn.dataset.chart;
                        this.updateChart(this.chartData);
                        
                        // Update chart title
                        const chartTitle = document.getElementById('chartTitle');
                        if (chartTitle) {
                            chartTitle.textContent = this.mainChartMode === 'pnl' ? 
                                'Cumulative P&L Timeline' : 'Drawdown Timeline';
                        }
                    });
                });
                
                // Zoom Stats button
                const zoomStatsBtn = document.getElementById('zoomStatsBtn');
                if (zoomStatsBtn) {
                    zoomStatsBtn.addEventListener('click', () => {
                        this.showZoomedStats = !this.showZoomedStats;
                        
                        if (this.showZoomedStats) {
                            zoomStatsBtn.innerHTML = '<i class="ri-focus-3-line"></i> Show Full Stats';
                            zoomStatsBtn.classList.add('active');
                            // Load data with zoom range (stats only, not chart)
                            this.loadDataForZoomRange();
                        } else {
                            zoomStatsBtn.innerHTML = '<i class="ri-focus-3-line"></i> Show Zoomed Stats';
                            zoomStatsBtn.classList.remove('active');
                            // Load full stats without updating the chart
                            this.loadDataForFullStats();
                        }
                    });
                }

                // Theme controls
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                const themeSwitcher = document.getElementById('themeSwitcher');
                const lightModeBtn = document.getElementById('lightModeBtn');
                const darkModeBtn = document.getElementById('darkModeBtn');
                
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        themeSwitcher.classList.toggle('open');
                    });
                }
                
                if (lightModeBtn) {
                    lightModeBtn.addEventListener('click', () => {
                        document.documentElement.setAttribute('data-theme', 'light');
                        localStorage.setItem('themeMode', 'light');
                        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                        lightModeBtn.classList.add('active');
                        this.updateChartTheme();
                    });
                }
                
                if (darkModeBtn) {
                    darkModeBtn.addEventListener('click', () => {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        localStorage.setItem('themeMode', 'dark');
                        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                        darkModeBtn.classList.add('active');
                        this.updateChartTheme();
                    });
                }
                
                // Color options
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const accent = option.dataset.accent;
                        document.documentElement.setAttribute('data-accent', accent);
                        localStorage.setItem('accentColor', accent);
                        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                        this.updateChartTheme();
                    });
                });
                
                // Close theme switcher when clicking outside
                document.addEventListener('click', (e) => {
                    if (!themeSwitcher.contains(e.target)) {
                        themeSwitcher.classList.remove('open');
                    }
                });
            }
            
            checkIndividualChartsVisibility() {
                const chartsContainer = document.getElementById('individualCharts');
                
                // Show individual charts only when BOTH account and symbol are selected
                if (this.currentFilters.account !== 'all' && this.currentFilters.symbol !== 'all') {
                    chartsContainer.classList.add('show');
                    this.loadIndividualData();
                } else {
                    chartsContainer.classList.remove('show');
                }
            }
            
            async loadData(forceRefresh = false) {
                try {
                    const params = new URLSearchParams(this.currentFilters);
                    if (forceRefresh) {
                        params.set('_t', Date.now());
                    }
                    
                    // Fetch both timeline and fees data in parallel
                    const [timelineResponse, feesResponse] = await Promise.all([
                        fetch(`/api/okx/aggregate_timeline?${params}`),
                        fetch(`/api/okx/fees?${params}`)
                    ]);
                    
                    const data = await timelineResponse.json();
                    const feesData = await feesResponse.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.chartData = data.timeline;
                    this.summaryData = data.summary;
                    
                    this.updateStats(data.summary, data.account_summaries, feesData);
                    this.updateChart(data.timeline);
                    
                } catch (error) {
                    console.error('Error loading OKX data:', error);
                }
            }
            
            async loadDataForZoomRange() {
                if (!this.zoomRange) return;
                
                try {
                    const params = new URLSearchParams(this.currentFilters);
                    
                    // Add date range parameters
                    params.set('start_date', this.zoomRange.start);
                    params.set('end_date', this.zoomRange.end);
                    
                    // Fetch both timeline and fees data with date filters
                    const [timelineResponse, feesResponse] = await Promise.all([
                        fetch(`/api/okx/aggregate_timeline?${params}`),
                        fetch(`/api/okx/fees?${params}`)
                    ]);
                    
                    const data = await timelineResponse.json();
                    const feesData = await feesResponse.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Update stats with zoomed data but don't update the chart
                    // (we want to keep the zoom level)
                    this.updateStats(data.summary, data.account_summaries, feesData, true);
                    
                } catch (error) {
                    console.error('Error loading zoomed data:', error);
                }
            }
            
            async loadDataForFullStats() {
                // Load full data but only update stats, not the chart
                try {
                    const params = new URLSearchParams(this.currentFilters);
                    
                    // Fetch both timeline and fees data without date filters
                    const [timelineResponse, feesResponse] = await Promise.all([
                        fetch(`/api/okx/aggregate_timeline?${params}`),
                        fetch(`/api/okx/fees?${params}`)
                    ]);
                    
                    const data = await timelineResponse.json();
                    const feesData = await feesResponse.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Store the full data but don't update chart
                    this.summaryData = data.summary;
                    
                    // Update stats with full data, marking as not zoomed
                    this.updateStats(data.summary, data.account_summaries, feesData, false);
                    
                } catch (error) {
                    console.error('Error loading full stats:', error);
                }
            }
            
            async loadIndividualData() {
                // Use the account directly (already account1/2/3 format)
                const account = this.currentFilters.account;
                // Convert symbol from dashes to underscores for API
                const symbol = this.currentFilters.symbol.replace(/-/g, '_');
                
                if (!account || !symbol || account === 'all' || symbol === 'all') return;
                
                try {
                    // Load orders for position chart
                    const orderResponse = await fetch(`/api/okx/orders/${account}/${symbol}`);
                    const orderData = await orderResponse.json();
                    
                    if (!orderData.error) {
                        this.orderData = orderData;
                        this.updatePositionChart(orderData);
                    }
                    
                    // Load positions for distribution chart
                    const positionResponse = await fetch(`/api/okx/positions/${account}/${symbol}`);
                    const positionData = await positionResponse.json();
                    
                    if (!positionData.error) {
                        this.positionData = positionData;
                        this.updateDistributionChart();
                    }
                } catch (error) {
                    console.error('Error loading individual data:', error);
                }
            }
            
            updateStats(summary, accountSummaries, feesData, isZoomedData = false) {
                // Total P&L
                const pnlElement = document.getElementById('totalPnlValue');
                const pnlValue = summary.final_pnl;
                pnlElement.textContent = `$${pnlValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                // Use same color approach as modern dashboard
                if (pnlValue >= 0) {
                    pnlElement.style.color = '#10b981'; // Green for positive
                } else {
                    pnlElement.style.color = '#ef4444'; // Red for negative
                }
                
                // Keep the date subtitle always grey (neutral)
                const pnlChange = document.getElementById('totalPnlChange');
                if (pnlChange) {
                    pnlChange.className = 'stat-change'; // No positive/negative class, stays grey
                }
                
                // Update date range subtitle
                if (summary.date_range) {
                    const startDate = new Date(summary.date_range.start).toLocaleDateString();
                    const endDate = new Date(summary.date_range.end).toLocaleDateString();
                    const prefix = isZoomedData ? 'ðŸ” Zoomed: ' : '';
                    document.getElementById('pnlSubtitle').textContent = `${prefix}${startDate} - ${endDate}`;
                }
                
                // NEW: Update Win Rate
                const winRateElement = document.getElementById('winRateValue');
                const winRateSubtitle = document.getElementById('winRateSubtitle');
                if (winRateElement && summary.win_rate !== undefined) {
                    const winRate = summary.win_rate || 0;
                    winRateElement.textContent = `${winRate.toFixed(1)}%`;
                    winRateElement.style.color = winRate >= 50 ? '#10b981' : '#ef4444';
                    
                    const wins = summary.winning_positions || 0;
                    const total = summary.total_positions || 0;
                    winRateSubtitle.textContent = `${wins} wins / ${total} total`;
                }
                
                // NEW: Update Trading Activity (merged card)
                const totalTradesElement = document.getElementById('totalTradesValue');
                const tradingActivitySubtitle = document.getElementById('tradingActivitySubtitle');
                if (totalTradesElement && summary.total_orders !== undefined) {
                    const totalOrders = summary.total_orders || 0;
                    const totalPositions = summary.total_positions || 0;
                    
                    // Main value shows total orders
                    totalTradesElement.textContent = totalOrders.toLocaleString('en-US');
                    
                    // Subtitle shows both positions and orders
                    const posText = totalPositions === 1 ? 'position' : 'positions';
                    const ordText = totalOrders === 1 ? 'order' : 'orders';
                    tradingActivitySubtitle.textContent = `${totalPositions.toLocaleString()} ${posText} â€¢ ${totalOrders.toLocaleString()} ${ordText}`;
                }
                
                // NEW: Update Drawdown
                const drawdownElement = document.getElementById('drawdownValue');
                const drawdownSubtitle = document.getElementById('drawdownSubtitle');
                if (drawdownElement && summary.drawdown_details) {
                    const currentDrawdown = summary.current_drawdown || 0;
                    const maxDrawdown = summary.max_drawdown || 0;
                    const currentAmount = summary.drawdown_details.current_amount || 0;
                    const maxAmount = summary.drawdown_details.max_amount || 0;
                    const peakValue = summary.drawdown_details.peak_value || 0;
                    
                    // Always display percentage as main value (capped at -100%)
                    drawdownElement.textContent = `${currentDrawdown.toFixed(1)}%`;
                    drawdownElement.style.color = currentDrawdown < -5 ? '#ef4444' : (currentDrawdown < 0 ? '#f59e0b' : '#10b981');
                    
                    // Display dollar amounts in subtitle with clear labels
                    // Format showing current drawdown and historical maximum drawdown
                    const currentAmountText = Math.abs(currentAmount).toFixed(0);
                    const maxAmountText = Math.abs(maxAmount).toFixed(0);
                    const peakText = peakValue > 0 ? `$${peakValue.toFixed(0)}` : '$0';
                    
                    // More intuitive format: "Current: -$X | Max: -$Y (Peak: $Z)"
                    drawdownSubtitle.textContent = `Current: -$${currentAmountText} | Max: -$${maxAmountText}`;
                }
                
                // NEW: Update Total Fees
                const totalFeesElement = document.getElementById('totalFeesValue');
                const totalFeesSubtitle = document.getElementById('totalFeesSubtitle');
                if (totalFeesElement && feesData) {
                    const totalFees = feesData.total_fees || 0;
                    const tradingFees = feesData.trading_fees || 0;
                    const fundingFees = feesData.funding_fees || 0;
                    
                    totalFeesElement.textContent = `$${totalFees.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    totalFeesSubtitle.textContent = `Trading: $${tradingFees.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} â€¢ Funding: $${fundingFees.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
                
                // Update individual account values in nav if they exist
                if (accountSummaries) {
                    ['account1', 'account2', 'account3'].forEach(account => {
                        const summary = accountSummaries[account];
                        if (summary && document.getElementById(`${account}Value`)) {
                            const element = document.getElementById(`${account}Value`);
                            const value = summary.final_pnl;
                            element.textContent = `$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            element.style.color = value >= 0 ? '#10b981' : '#ef4444';
                        }
                    });
                }
            }
            
            updateChart(timeline) {
                if (!timeline || timeline.length === 0) return;
                
                const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                
                let trace, yAxisTitle;
                
                if (this.mainChartMode === 'drawdown') {
                    // Calculate drawdown from P&L data
                    let runningMax = timeline[0]?.cumulative_usd_pnl || 0;
                    const drawdownData = timeline.map(point => {
                        runningMax = Math.max(runningMax, point.cumulative_usd_pnl);
                        const drawdown = runningMax > 0 ? 
                            ((point.cumulative_usd_pnl - runningMax) / runningMax * 100) : 0;
                        return {
                            datetime: point.datetime,
                            drawdown: drawdown
                        };
                    });
                    
                    trace = {
                        x: drawdownData.map(point => point.datetime),
                        y: drawdownData.map(point => point.drawdown),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Drawdown %',
                        line: {
                            color: '#ef4444', // Red for drawdown
                            width: 2
                        },
                        fill: 'tozeroy',
                        fillcolor: 'rgba(239, 68, 68, 0.2)' // Red fill
                    };
                    
                    yAxisTitle = 'Drawdown (%)';
                } else {
                    // P&L mode (default)
                    trace = {
                        x: timeline.map(point => point.datetime),
                        y: timeline.map(point => point.cumulative_usd_pnl),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Cumulative P&L',
                        line: {
                            color: primaryColor || '#6366f1',
                            width: 2
                        },
                        fill: 'tozeroy',
                        fillcolor: primaryColor ? `${primaryColor}20` : 'rgba(99, 102, 241, 0.1)'
                    };
                    
                    yAxisTitle = 'Cumulative P&L (USD)';
                }
                
                const layout = {
                    xaxis: {
                        title: '',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b',
                        rangeselector: {
                            buttons: [
                                { count: 1, label: '1D', step: 'day', stepmode: 'backward' },
                                { count: 7, label: '1W', step: 'day', stepmode: 'backward' },
                                { count: 1, label: '1M', step: 'month', stepmode: 'backward' },
                                { count: 3, label: '3M', step: 'month', stepmode: 'backward' },
                                { count: 6, label: '6M', step: 'month', stepmode: 'backward' },
                                { step: 'all', label: 'All' }
                            ],
                            bgcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                            bordercolor: primaryColor || '#6366f1',
                            activecolor: primaryColor || '#6366f1',
                            font: { color: isDarkMode ? '#94a3b8' : '#64748b' }
                        },
                        rangeslider: { visible: false }
                    },
                    yaxis: {
                        title: yAxisTitle,
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b',
                        zeroline: true,
                        zerolinewidth: 1,
                        zerolinecolor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    font: {
                        family: 'Inter, sans-serif',
                        size: 12,
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    margin: { t: 20, r: 20, b: 50, l: 80 },
                    showlegend: false,
                    hovermode: 'x unified'
                };
                
                // Apply saved zoom range if it exists
                if (this.zoomRange && this.zoomRange.start && this.zoomRange.end) {
                    layout.xaxis.range = [this.zoomRange.start, this.zoomRange.end];
                }
                
                const config = {
                    displayModeBar: false,
                    responsive: true
                };
                
                Plotly.newPlot('cumulativePnlChart', [trace], layout, config);
                
                // Add zoom detection
                const chartDiv = document.getElementById('cumulativePnlChart');
                chartDiv.on('plotly_relayout', (eventData) => {
                    // Ignore events triggered during sync
                    if (this.isSyncingZoom) return;
                    
                    // Check if this is a zoom event (has xaxis range)
                    if (eventData['xaxis.range[0]'] && eventData['xaxis.range[1]']) {
                        this.isZoomed = true;
                        this.zoomRange = {
                            start: eventData['xaxis.range[0]'],
                            end: eventData['xaxis.range[1]']
                        };
                        
                        // Show the zoom stats button
                        const zoomStatsBtn = document.getElementById('zoomStatsBtn');
                        if (zoomStatsBtn) {
                            zoomStatsBtn.style.display = 'inline-flex';
                        }
                        
                        // Sync zoom to other charts if showing individual view
                        if (this.currentFilters.account !== 'all' && this.currentFilters.symbol !== 'all') {
                            this.syncZoomToOtherCharts('cumulativePnlChart');
                        }
                    } else if (eventData['xaxis.autorange']) {
                        // Chart was reset to full range
                        this.isZoomed = false;
                        this.zoomRange = null;
                        
                        // Hide the zoom stats button and reset it
                        const zoomStatsBtn = document.getElementById('zoomStatsBtn');
                        if (zoomStatsBtn) {
                            zoomStatsBtn.style.display = 'none';
                            zoomStatsBtn.innerHTML = '<i class="ri-focus-3-line"></i> Show Zoomed Stats';
                            zoomStatsBtn.classList.remove('active');
                        }
                        
                        // If we were showing zoomed stats, reload full stats
                        if (this.showZoomedStats) {
                            this.showZoomedStats = false;
                            this.loadDataForFullStats();
                        }
                        
                        // Reset zoom on other charts if showing individual view
                        if (this.currentFilters.account !== 'all' && this.currentFilters.symbol !== 'all') {
                            this.syncZoomToOtherCharts('cumulativePnlChart');
                        }
                    }
                });
            }
            
            updatePositionChart(data) {
                if (!data || !data.cumulative_data) return;
                
                const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
                const orders = data.cumulative_data;
                
                // Store the data for zoom sync
                this.positionChartData = orders;
                
                // Get the theme primary color
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                
                // Create step chart for positions
                const trace = {
                    x: orders.map(o => o.datetime),
                    y: orders.map(o => o.cumulative_position),
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        shape: 'hv',
                        color: primaryColor || '#6366f1',
                        width: 2
                    },
                    fill: 'tozeroy',
                    fillcolor: primaryColor ? `${primaryColor}20` : 'rgba(99, 102, 241, 0.1)',
                    name: 'Position'
                };
                
                const layout = {
                    xaxis: {
                        title: '',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    yaxis: {
                        title: 'Contracts',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b',
                        zeroline: true,
                        zerolinewidth: 2,
                        zerolinecolor: isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)'
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    font: {
                        family: 'Inter, sans-serif',
                        size: 12,
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    margin: { t: 20, r: 20, b: 50, l: 80 },
                    showlegend: false,
                    hovermode: 'x unified'
                };
                
                // Apply saved zoom range if it exists
                if (this.zoomRange && this.zoomRange.start && this.zoomRange.end) {
                    layout.xaxis.range = [this.zoomRange.start, this.zoomRange.end];
                }
                
                const config = {
                    displayModeBar: false,
                    responsive: true
                };
                
                Plotly.newPlot('positionChart', [trace], layout, config);
                
                // Add zoom detection for this chart
                const chartDiv = document.getElementById('positionChart');
                chartDiv.on('plotly_relayout', (eventData) => {
                    // Ignore events triggered during sync
                    if (this.isSyncingZoom) return;
                    
                    // Check if this is a zoom event (has xaxis range)
                    if (eventData['xaxis.range[0]'] && eventData['xaxis.range[1]']) {
                        this.isZoomed = true;
                        this.zoomRange = {
                            start: eventData['xaxis.range[0]'],
                            end: eventData['xaxis.range[1]']
                        };
                        
                        // Show the zoom stats button
                        const zoomStatsBtn = document.getElementById('zoomStatsBtn');
                        if (zoomStatsBtn) {
                            zoomStatsBtn.style.display = 'inline-flex';
                        }
                        
                        // Sync zoom to other charts
                        this.syncZoomToOtherCharts('positionChart');
                    } else if (eventData['xaxis.autorange']) {
                        // Chart was reset to full range
                        this.isZoomed = false;
                        this.zoomRange = null;
                        
                        // Hide the zoom stats button and reset it
                        const zoomStatsBtn = document.getElementById('zoomStatsBtn');
                        if (zoomStatsBtn) {
                            zoomStatsBtn.style.display = 'none';
                            zoomStatsBtn.innerHTML = '<i class="ri-focus-3-line"></i> Show Zoomed Stats';
                            zoomStatsBtn.classList.remove('active');
                        }
                        
                        // Reset zoom on other charts
                        this.syncZoomToOtherCharts('positionChart');
                    }
                });
            }
            
            async updateAnalyticsPositionCount() {
                // Quickly fetch just the position count for the header
                const params = new URLSearchParams({
                    account: this.currentFilters.account,
                    symbol: this.currentFilters.symbol
                });
                
                try {
                    const response = await fetch(`/api/okx/position-analytics?${params}`);
                    const data = await response.json();
                    
                    if (!data.error && data.trade_count !== undefined) {
                        document.getElementById('analyticsTradeCount').textContent = `(${data.trade_count} positions)`;
                    }
                } catch (error) {
                    // Silent fail - not critical
                }
            }
            
            async loadExtendedAnalytics() {
                // Fetch analytics data based on current filters
                const params = new URLSearchParams({
                    account: this.currentFilters.account,
                    symbol: this.currentFilters.symbol
                });
                
                try {
                    const response = await fetch(`/api/okx/position-analytics?${params}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        console.error('Error loading analytics:', data.error);
                        return;
                    }
                    
                    this.analyticsData = data;
                    this.updateAnalyticsDisplay();
                } catch (error) {
                    console.error('Failed to load analytics:', error);
                }
            }
            
            updateAnalyticsDisplay() {
                if (!this.analyticsData) return;
                
                const data = this.analyticsData;
                const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
                
                // Update trade count in header
                document.getElementById('analyticsTradeCount').textContent = `(${data.trade_count} positions)`;
                
                // Show/hide warning for low trade count
                const warningDiv = document.getElementById('analyticsWarning');
                const warningText = document.getElementById('analyticsWarningText');
                if (data.trade_count < 30) {
                    warningDiv.style.display = 'block';
                    warningText.textContent = `Only ${data.trade_count} positions available. Distribution charts may not be statistically meaningful.`;
                } else {
                    warningDiv.style.display = 'none';
                }
                
                // Update Return Distribution Chart
                this.updateReturnDistributionChart(data.return_distribution);
                
                // Update Hold Time Chart
                this.updateHoldTimeChart(data.hold_time_distribution);
                
                // Update Instrument Performance Table
                this.updateInstrumentPerformanceTable(data.instrument_performance);
                
                // Update Market vs Model Return Analysis - REMOVED
                // if (data.market_vs_model) {
                //     this.updateMarketVsModelChart(data.market_vs_model);
                //     this.updateEfficiencyMetrics(data.market_vs_model.efficiency_metrics);
                // }
            }
            
            updateReturnDistributionChart(distribution) {
                if (!distribution || !distribution.raw_returns) return;
                
                const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                
                const trace = {
                    x: distribution.raw_returns,
                    type: 'histogram',
                    nbinsx: 50,
                    marker: {
                        color: primaryColor || '#6366f1',  // Use theme's primary color
                        line: {
                            color: isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)',
                            width: 1
                        }
                    },
                    hovertemplate: 'Return: %{x:.2f}%<br>Count: %{y}<extra></extra>'
                };
                
                const layout = {
                    xaxis: {
                        title: 'Return (%)',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b',
                        range: [-10, 10]  // Focus on -10% to +10% range
                    },
                    yaxis: {
                        title: 'Frequency',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    font: {
                        family: 'Inter, sans-serif',
                        size: 12,
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    margin: { t: 20, b: 60, l: 60, r: 20 },
                    bargap: 0.05,
                    showlegend: false
                };
                
                const config = {
                    displayModeBar: false,
                    responsive: true
                };
                
                Plotly.newPlot('returnDistributionChart', [trace], layout, config);
            }
            
            updateHoldTimeChart(holdTimeData) {
                if (!holdTimeData || !holdTimeData.categories) return;
                
                const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                
                const trace = {
                    x: holdTimeData.categories,
                    y: holdTimeData.counts,
                    type: 'bar',
                    marker: {
                        color: primaryColor || '#6366f1',
                        line: {
                            color: isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)',
                            width: 1
                        }
                    },
                    text: holdTimeData.counts.map(c => c.toString()),
                    textposition: 'outside',
                    hovertemplate: '%{x}<br>Positions: %{y}<extra></extra>'
                };
                
                const layout = {
                    xaxis: {
                        title: 'Hold Time',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    yaxis: {
                        title: 'Number of Positions',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    font: {
                        family: 'Inter, sans-serif',
                        size: 12,
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    margin: { t: 20, b: 60, l: 60, r: 20 },
                    showlegend: false
                };
                
                const config = {
                    displayModeBar: false,
                    responsive: true
                };
                
                Plotly.newPlot('holdTimeChart', [trace], layout, config);
            }
            
            updateInstrumentPerformanceTable(instruments) {
                const container = document.getElementById('instrumentPerformanceContainer');
                const tbody = document.getElementById('instrumentPerformanceBody');
                
                // Only show table if we have multiple instruments
                if (!instruments || instruments.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                
                // Show table only when viewing all symbols
                if (this.currentFilters.symbol !== 'all') {
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'block';
                tbody.innerHTML = '';
                
                instruments.forEach((inst, index) => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--border-color)';
                    row.style.transition = 'background-color 0.2s';
                    
                    // Hover effect
                    row.onmouseenter = () => row.style.backgroundColor = 'rgba(99, 102, 241, 0.05)';
                    row.onmouseleave = () => row.style.backgroundColor = 'transparent';
                    
                    const winRateClass = inst.win_rate >= 50 ? 'text-success' : 'text-danger';
                    const pnlClass = inst.net_pnl >= 0 ? 'text-success' : 'text-danger';
                    
                    // Create win rate bar visualization
                    const winRateBar = `
                        <div style="display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
                            <div style="width: 60px; height: 6px; background: rgba(239, 68, 68, 0.2); border-radius: 3px; position: relative;">
                                <div style="width: ${inst.win_rate}%; height: 100%; background: ${inst.win_rate >= 50 ? '#10b981' : '#ef4444'}; border-radius: 3px;"></div>
                            </div>
                            <span class="${winRateClass}" style="font-weight: 600; min-width: 45px; text-align: left;">${inst.win_rate}%</span>
                        </div>
                    `;
                    
                    row.innerHTML = `
                        <td style="padding: 14px 16px; font-weight: 600; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 8px; height: 8px; background: var(--primary-color); border-radius: 50%;"></div>
                                ${inst.instrument}
                            </div>
                        </td>
                        <td style="padding: 14px 16px; text-align: right; font-weight: 500;">
                            <span style="background: rgba(99, 102, 241, 0.1); padding: 4px 8px; border-radius: 4px;">
                                ${inst.total_trades}
                            </span>
                        </td>
                        <td style="padding: 14px 16px; text-align: right;">${winRateBar}</td>
                        <td style="padding: 14px 16px; text-align: right;">
                            <span style="color: #10b981; font-weight: 500;">${inst.wins}</span>
                            <span style="color: #94a3b8;">/</span>
                            <span style="color: #ef4444; font-weight: 500;">${inst.losses}</span>
                        </td>
                        <td style="padding: 14px 16px; text-align: right;" class="${inst.total_pnl >= 0 ? 'text-success' : 'text-danger'}">
                            <strong>${inst.total_pnl >= 0 ? '+' : ''}$${inst.total_pnl.toFixed(2)}</strong>
                        </td>
                        <td style="padding: 14px 16px; text-align: right;" class="text-danger">
                            -$${Math.abs(inst.total_fees).toFixed(2)}
                        </td>
                        <td style="padding: 14px 16px; text-align: right; font-size: 1.1em;" class="${pnlClass}">
                            <strong>${inst.net_pnl >= 0 ? '+' : ''}$${inst.net_pnl.toFixed(2)}</strong>
                        </td>
                        <td style="padding: 14px 16px; text-align: right;">
                            <span style="opacity: 0.8;">${inst.avg_hold_time.toFixed(1)}h</span>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            updateMarketVsModelChart(data) {
                if (!data || !data.timestamps || data.timestamps.length === 0) {
                    document.getElementById('marketVsModelChart').innerHTML = '<div style="text-align: center; padding: 50px; color: var(--text-secondary);">No data available</div>';
                    return;
                }
                
                const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
                
                // Create time series traces
                const marketTrace = {
                    x: data.timestamps,
                    y: data.market_returns,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Market Return (When Positions Held)',
                    line: {
                        color: '#6366f1',
                        width: 2
                    },
                    hovertemplate: 'Date: %{x}<br>Market Return: %{y:.2f}%<extra></extra>'
                };
                
                const modelTrace = {
                    x: data.timestamps,
                    y: data.model_returns,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Model Return (Actual)',
                    line: {
                        color: '#10b981',
                        width: 2
                    },
                    hovertemplate: 'Date: %{x}<br>Model Return: %{y:.2f}%<extra></extra>'
                };
                
                // Add zero line
                const zeroLine = {
                    x: [data.timestamps[0], data.timestamps[data.timestamps.length - 1]],
                    y: [0, 0],
                    mode: 'lines',
                    type: 'scatter',
                    line: {
                        color: isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)',
                        width: 1,
                        dash: 'dash'
                    },
                    showlegend: false,
                    hoverinfo: 'skip'
                };
                
                const layout = {
                    xaxis: {
                        title: 'Date',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b',
                        type: 'date'
                    },
                    yaxis: {
                        title: 'Cumulative Return (%)',
                        gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        color: isDarkMode ? '#94a3b8' : '#64748b',
                        zeroline: false
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    font: {
                        family: 'Inter, sans-serif',
                        size: 12,
                        color: isDarkMode ? '#94a3b8' : '#64748b'
                    },
                    margin: { t: 20, b: 60, l: 60, r: 20 },
                    showlegend: true,
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: 1.02,
                        xanchor: 'right',
                        x: 1,
                        bgcolor: 'transparent',
                        bordercolor: 'transparent',
                        font: {
                            size: 11
                        }
                    },
                    annotations: [
                        {
                            x: 0.02,
                            y: 0.98,
                            xref: 'paper',
                            yref: 'paper',
                            text: `Final Difference: ${((data.model_returns[data.model_returns.length-1] || 0) - (data.market_returns[data.market_returns.length-1] || 0)).toFixed(2)}%`,
                            showarrow: false,
                            bgcolor: isDarkMode ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.9)',
                            bordercolor: 'var(--border-light)',
                            borderwidth: 1,
                            borderpad: 4,
                            font: {
                                size: 11,
                                color: isDarkMode ? '#94a3b8' : '#64748b'
                            }
                        }
                    ]
                };
                
                const config = {
                    displayModeBar: false,
                    responsive: true
                };
                
                Plotly.newPlot('marketVsModelChart', [zeroLine, marketTrace, modelTrace], layout, config);
            }
            
            updateEfficiencyMetrics(metrics) {
                // Update to show time series relevant metrics
                const data = this.analyticsData?.market_vs_model;
                if (!data || !data.market_returns || data.market_returns.length === 0) {
                    document.getElementById('efficiencyMetrics').innerHTML = '<div style="text-align: center; color: var(--text-secondary);">No metrics available</div>';
                    return;
                }
                
                const finalMarket = data.market_returns[data.market_returns.length - 1] || 0;
                const finalModel = data.model_returns[data.model_returns.length - 1] || 0;
                const underperformance = finalModel - finalMarket;
                
                const metricsHTML = `
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="metric-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary); font-size: 0.9em;">Market Return</span>
                                <span style="color: ${finalMarket >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; font-size: 1.2em;">${finalMarket.toFixed(2)}%</span>
                            </div>
                            <div style="font-size: 0.75em; color: var(--text-secondary);">When positions were held</div>
                        </div>
                        
                        <div class="metric-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary); font-size: 0.9em;">Model Return</span>
                                <span style="color: ${finalModel >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; font-size: 1.2em;">${finalModel.toFixed(2)}%</span>
                            </div>
                            <div style="font-size: 0.75em; color: var(--text-secondary);">Actual achieved</div>
                        </div>
                        
                        <div style="border-top: 1px solid var(--border-light); padding-top: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary); font-size: 0.9em;">Performance Gap</span>
                                <span style="color: ${underperformance >= 0 ? '#10b981' : '#ef4444'}; font-weight: 700; font-size: 1.3em;">${underperformance.toFixed(2)}%</span>
                            </div>
                            <div style="font-size: 0.75em; color: var(--text-secondary);">
                                ${underperformance < 0 ? 'Underperforming market' : 'Outperforming market'}
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid var(--border-light); padding-top: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="color: var(--text-secondary); font-size: 0.85em;">Total Positions</span>
                                <span style="color: var(--text-primary); font-weight: 600;">${metrics?.total_comparisons || data.timestamps?.length || 0}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="color: var(--text-secondary); font-size: 0.85em;">Avg Fee Impact</span>
                                <span style="color: #f59e0b; font-weight: 600;">${metrics?.avg_fee_impact || -0.05}%</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(99, 102, 241, 0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(99, 102, 241, 0.2); margin-top: 12px;">
                            <div style="font-size: 0.8em; color: var(--text-secondary); line-height: 1.5;">
                                <div style="margin-bottom: 4px;">ðŸ“Š <strong>How to Read:</strong></div>
                                <div style="margin-left: 10px;">
                                    <div>â€¢ <span style="color: #6366f1;">Blue line</span>: Market moves during positions</div>
                                    <div>â€¢ <span style="color: #10b981;">Green line</span>: Model's actual returns</div>
                                    <div>â€¢ Gap between lines = Performance difference</div>
                                    <div>â€¢ Negative gap = Underperformance</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('efficiencyMetrics').innerHTML = metricsHTML;
            }
            
            updateDistributionChart() {
                if (!this.positionData || !this.positionData.positions) return;
                
                const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
                let positions = this.positionData.positions;
                
                // Filter positions by zoom range if zoomed and in timeline mode
                if (this.zoomRange && this.distributionViewMode === 'timeline') {
                    const startDate = new Date(this.zoomRange.start);
                    const endDate = new Date(this.zoomRange.end);
                    positions = positions.filter(p => {
                        const posDate = new Date(p.cDateTime || p.uDateTime);
                        return posDate >= startDate && posDate <= endDate;
                    });
                }
                
                if (this.distributionViewMode === 'histogram') {
                    // Histogram view - matching okx-positions exactly
                    const trace = {
                        x: positions.map(p => p.return_pct || 0),
                        type: 'histogram',
                        nbinsx: 30,
                        marker: {
                            color: positions.map(p => p.return_pct >= 0 ? '#48bb78' : '#fc8181'),
                        },
                        name: 'Position Returns'
                    };
                    
                    const layout = {
                        xaxis: { 
                            title: 'Return (%)',
                            gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                            color: isDarkMode ? '#94a3b8' : '#64748b'
                        },
                        yaxis: { 
                            title: 'Frequency',
                            gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                            color: isDarkMode ? '#94a3b8' : '#64748b'
                        },
                        plot_bgcolor: 'transparent',
                        paper_bgcolor: 'transparent',
                        font: {
                            family: 'Inter, sans-serif',
                            size: 12,
                            color: isDarkMode ? '#94a3b8' : '#64748b'
                        },
                        margin: { t: 20, b: 60 },
                        bargap: 0.05,
                        showlegend: false
                    };
                    
                    const config = {
                        displayModeBar: false,
                        responsive: true
                    };
                    
                    Plotly.newPlot('distributionChart', [trace], layout, config);
                } else {
                    // Timeline view - matching okx-positions exactly
                    const trace = {
                        x: positions.map(p => p.cDateTime || p.uDateTime),
                        y: positions.map(p => p.return_pct || 0),
                        type: 'bar',
                        marker: {
                            color: positions.map(p => p.return_pct >= 0 ? '#48bb78' : '#fc8181'),
                        },
                        name: 'Individual Returns'
                    };
                    
                    const layout = {
                        xaxis: { 
                            title: 'Date',
                            gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                            color: isDarkMode ? '#94a3b8' : '#64748b'
                        },
                        yaxis: { 
                            title: 'Return (%)',
                            gridcolor: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                            color: isDarkMode ? '#94a3b8' : '#64748b'
                        },
                        plot_bgcolor: 'transparent',
                        paper_bgcolor: 'transparent',
                        font: {
                            family: 'Inter, sans-serif',
                            size: 12,
                            color: isDarkMode ? '#94a3b8' : '#64748b'
                        },
                        margin: { t: 20, b: 60 },
                        showlegend: false
                    };
                    
                    // Apply saved zoom range if it exists (for timeline view)
                    if (this.zoomRange && this.zoomRange.start && this.zoomRange.end) {
                        layout.xaxis.range = [this.zoomRange.start, this.zoomRange.end];
                    }
                    
                    const config = {
                        displayModeBar: false,
                        responsive: true
                    };
                    
                    Plotly.newPlot('distributionChart', [trace], layout, config);
                    
                    // Add zoom detection for timeline view
                    const chartDiv = document.getElementById('distributionChart');
                    if (chartDiv && chartDiv.on) {
                        chartDiv.on('plotly_relayout', (eventData) => {
                        // Ignore events triggered during sync
                        if (this.isSyncingZoom) return;
                        
                        // Check if this is a zoom event (has xaxis range)
                        if (eventData['xaxis.range[0]'] && eventData['xaxis.range[1]']) {
                            this.isZoomed = true;
                            this.zoomRange = {
                                start: eventData['xaxis.range[0]'],
                                end: eventData['xaxis.range[1]']
                            };
                            
                            // Show the zoom stats button
                            const zoomStatsBtn = document.getElementById('zoomStatsBtn');
                            if (zoomStatsBtn) {
                                zoomStatsBtn.style.display = 'inline-flex';
                            }
                            
                            // Sync zoom to other charts
                            this.syncZoomToOtherCharts('distributionChart');
                        } else if (eventData['xaxis.autorange']) {
                            // Chart was reset to full range
                            this.isZoomed = false;
                            this.zoomRange = null;
                            
                            // Hide the zoom stats button and reset it
                            const zoomStatsBtn = document.getElementById('zoomStatsBtn');
                            if (zoomStatsBtn) {
                                zoomStatsBtn.style.display = 'none';
                                zoomStatsBtn.innerHTML = '<i class="ri-focus-3-line"></i> Show Zoomed Stats';
                                zoomStatsBtn.classList.remove('active');
                            }
                            
                            // Reset zoom on other charts
                            this.syncZoomToOtherCharts('distributionChart');
                        }
                    });
                    }
                }
            }
            
            syncZoomToOtherCharts(sourceChart = null) {
                // Only sync if we're in individual view mode
                if (this.currentFilters.account === 'all' || this.currentFilters.symbol === 'all') {
                    return;
                }
                
                // Prevent infinite loops
                if (this.isSyncingZoom) {
                    return;
                }
                
                // Set flag to prevent recursive calls
                this.isSyncingZoom = true;
                
                // List of charts to sync
                const charts = ['cumulativePnlChart', 'positionChart', 'distributionChart'];
                
                // Update each chart except the source
                charts.forEach(chartId => {
                    if (chartId === sourceChart) return; // Skip the chart that triggered the sync
                    
                    try {
                        const chartDiv = document.getElementById(chartId);
                        if (!chartDiv || !chartDiv._fullLayout) return; // Skip if chart doesn't exist
                        
                        // Apply or reset the zoom range
                        if (this.zoomRange) {
                            Plotly.relayout(chartId, {
                                'xaxis.range[0]': this.zoomRange.start,
                                'xaxis.range[1]': this.zoomRange.end
                            });
                        } else {
                            Plotly.relayout(chartId, {
                                'xaxis.autorange': true
                            });
                        }
                    } catch (error) {
                        console.warn(`Could not sync zoom to ${chartId}:`, error);
                    }
                });
                
                // If distribution chart is in timeline mode and zoom changed, update it
                if (sourceChart !== 'distributionChart' && this.distributionViewMode === 'timeline' && this.positionData) {
                    try {
                        this.updateDistributionChart();
                    } catch (error) {
                        console.warn('Could not update distribution chart:', error);
                    }
                }
                
                // Reset flag after a short delay to allow all events to complete
                setTimeout(() => {
                    this.isSyncingZoom = false;
                }, 100);
            }
            
            updateChartTimeRange(range) {
                if (!this.chartData) return;
                
                let startDate;
                const endDate = new Date();
                
                switch(range) {
                    case '1D':
                        startDate = new Date(endDate.getTime() - 24 * 60 * 60 * 1000);
                        break;
                    case '1W':
                        startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '1M':
                        startDate = new Date(endDate.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case '3M':
                        startDate = new Date(endDate.getTime() - 90 * 24 * 60 * 60 * 1000);
                        break;
                    case '6M':
                        startDate = new Date(endDate.getTime() - 180 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        this.updateChart(this.chartData);
                        return;
                }
                
                const filteredData = this.chartData.filter(point => {
                    const pointDate = new Date(point.datetime);
                    return pointDate >= startDate && pointDate <= endDate;
                });
                
                this.updateChart(filteredData);
            }
            
            updateChartTheme() {
                // Re-render charts with new theme colors
                if (this.chartData) {
                    this.updateChart(this.chartData);
                }
                if (this.orderData) {
                    this.updatePositionChart(this.orderData);
                }
                if (this.positionData) {
                    this.updateDistributionChart();
                }
            }
        }
        
        // CSV Download Function
        async function downloadPositionsCSV() {
            // Get the current account from nav-pills
            const activeAccountPill = document.querySelector('.nav-pill.active');
            let account = 'all';
            if (activeAccountPill && activeAccountPill.dataset.account) {
                const accountMapping = {
                    'account1': 'cyg6',
                    'account2': 'cyg7',
                    'account3': 'cyg8',
                    'all': 'all'
                };
                account = accountMapping[activeAccountPill.dataset.account] || 'all';
            }
            
            // Get the download button
            const button = document.querySelector('.download-pill');
            const originalContent = button.innerHTML;
            
            // Show loading state
            button.innerHTML = `
                <i class="ri-loader-line animate-spin"></i>
                Generating CSV...
            `;
            button.disabled = true;
            
            try {
                // Make request to download endpoint
                const response = await fetch(`/api/okx/positions/download/${account}`);
                
                if (!response.ok) {
                    throw new Error('Failed to generate CSV');
                }
                
                // Get the blob data
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                // Get filename from response headers or use default
                const contentDisposition = response.headers.get('content-disposition');
                let filename = `okx_positions_${account}_${new Date().toISOString().slice(0,10)}.csv`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success
                button.innerHTML = `
                    <i class="ri-check-line"></i>
                    Downloaded!
                `;
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Download error:', error);
                
                // Show error
                button.innerHTML = `
                    <i class="ri-error-warning-line"></i>
                    Error
                `;
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 2000);
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 300);
            }, 500);
            
            // Initialize OKX dashboard
            new OKXDashboard();
            
            // Initialize particles (from modern-dashboard.js)
            if (typeof initParticles === 'function') {
                initParticles();
            }
        });
    </script>
</body>
</html>